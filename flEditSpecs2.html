<style>
    .fleddat-matrix {
        display: grid;
        width: 100%;
        grid-template-columns: 12% 8% 48% 32%;
        --fleddat-cellH: calc(var(--flw-height) / 33);
        font-size: calc(var(--fleddat-cellH) * 0.5);
    }
    .fleddat-cell {
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-sizing: border-box;
        color: black;
        margin: 0.25em;
        height: calc(var(--fleddat-cellH) - 0.5em);
    }
    .fleddat-cell-disp {
        flex-direction: row;
        justify-content: space-between;
    }
    .fleddat-c1 {
        background-color: var(--theme-color-bg);
        text-align: left;
        padding: 0 0 0 0.7em;
        font-size: 1em;
    }
    .fleddat-c1b {
        text-align: right;
        padding: 0 0.7em 0 0;
        color: var(--theme-color-fg2);
        font-style: italic;
    }
    .fleddat-inp {
        background-color: white;
        font-size: 0.75em;
        resize: none;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .fleddat-inp::-webkit-scrollbar {
        display: none;
    }
    .fleddat-number {
        text-align: right;
        padding-right: 0.25em;
    }
    .fleddat-text {
        text-align: left;
        padding-left: 0.5em;
    }
    .fleddat-textarea {
        text-align: left;
        padding-left: 0.5em;
    }
    .fleddat-submit {
        background-color: grey;
        text-align: center;
        font-size: 1em;
        color: white;
        cursor: pointer;
    }
    .fleddat-submit:hover {
        background-color: var(--theme-color-system);
    }
    .fleddat-matrix-1{
        display: flex;
        flex-wrap: wrap;
    }
    .fleddat-matrix-1 .fleddat-c1.fleddat-cell{
        display: flex;
        align-items: center;
        flex-direction: row;
        width: 24%;
        flex-shrink: 0;
    }
    .fleddat-matrix-1 .fleddat-c1.fleddat-cell span{
        width: 70px;
        display: inline-block;
        flex-shrink: 0;
        text-align: right;
        padding-right: 8px;
    }
    .fleddat-matrix-1 .fleddat-c1.fleddat-cell input{
        width: 100%;
    }
    .fleddat-matrix-1.android .fleddat-cell{
        width: 97%;
        justify-content: flex-start;
    }
    .fleddat-matrix-1.android .fleddat-c1.fleddat-cell input{
        flex-grow: 1;
    }
    .fleddat-matrix-1.android .fleddat-c1.fleddat-cell span{
        width: 10%;
        min-width: 58px;
        text-align: left;
    }
    .edit-specs-component .flw-body {
        --flw-height: 78vh !important;
    }
</style>

<script>
    function flEditSpecs(org) {
        Element.prototype.setAt = function(x1, y1, x2=x1, y2=y1) {
            this.style.gridRow = (y1+1) + " / " + (y2+2);
            this.style.gridColumn = (x1+1) + " / " + (x2+2);
            return this;
        }

        createLabel = function(_base, _x1, _y1, _x2, _y2) {
            var label = $$$(_base, "div", "fleddat-cell fleddat-c1", pname + "-fleddat-cell-" + _x1 + "-" + _y1);
            label.setAt(_x1, _y1, _x2, _y2);
            return label;
        }

        createDropDown = function(_base, _options, _x1, _y1, _x2, _y2) {
            var select = $$$(_base, "select", "fleddat-cell fleddat-inp", pname + "-fleddat-cell-" + _x1 + "-" + _y1);
            select.setAt(_x1, _y1, _x2, _y2);
            for (opt of _options) {
                option = document.createElement("option");
                option.value = option.text = opt;
                select.add(option);
            }
            return select;
        }

        createEmptyInput = function(_base, _x1, _y1) {
            var input = $$$(_base, "input", "fleddat-cell fleddat-inp fleddat-text", pname + "-fleddat-cell-other-" + _x1 + "-" + _y1);
            input.type = 'text';
            return input;
        }

        createInput = function(_base, _type, _x1, _y1, _x2, _y2) {
            switch (_type) {
                case "textarea":
                    var input = $$$(_base, "textarea", "fleddat-cell fleddat-inp fleddat-textarea", pname + "-fleddat-cell-" + _x1 + "-" + _y1);
                    break;
                default:
                    var input = $$$(_base, "input", "fleddat-cell fleddat-inp fleddat-" + _type, pname + "-fleddat-cell-" + _x1 + "-" + _y1);
                    input.type = _type;
            }
            input.setAt(_x1, _y1, _x2, _y2);
            return input;
        }

        cellAt = function(_x, _y) {
            return $(pname + "-fleddat-cell-" + _x + "-" + _y);
        }

        cellOtherAt = function(_x, _y) {
            return $(pname + "-fleddat-cell-other-" + _x + "-" + _y);
        }

        createSelOfInput = function (selInput, _id, _options) {
            selInput.setAttribute("list", _id);
            const dl = $$$(selInput, "datalist");
            dl.id = _id;
            for (opt of _options) {
                $$$(dl, "option").innerHTML = opt;
            }
        }

        reCalc = function(_pname) {
            bu = 0;
            for (i=2; i<15; i++) bu += parseFloat($(_pname + "-fleddat-cell-1-" + i).value);
            $(_pname + "-fleddat-cell-1-1").value = bu.toFixed(2);

            total = parseFloat($(_pname + "-fleddat-cell-1-0").value);
            total += bu;
            for (i=15; i<26; i++) total += parseFloat($(_pname + "-fleddat-cell-1-" + i).value);
            $(_pname + "-fleddat-cell-1-26").value = total.toFixed(2);
        }

        toNum = function(_in) {
            if (_in=="") return 0;
            return parseFloat(_in);
        }

        pname = org.pname;

        // if this window is already opened, send a click to the header of it to make it come forward
        if ($(pname + " Specs Edit")) {
            $(pname + " Specs Edit").header.dispatchEvent(new Event('click'));
            return;
        }

        let compsData = {}
        google.script.run.withSuccessHandler(ret => {
            compsData = JSON.parse(ret)
        }).getCompsData()

        // load projects data
        $("spinner").style.display = "inline"; // start spinner
        google.script.run.withSuccessHandler(ret => {
            $("spinner").style.display = "none"; // stop spinner

            // check if data are loaded
            if (!ret) return;
            prj_data = JSON.parse(ret.prod);
            prj_note = JSON.parse(ret.note);

            // create window
            let fdata = {
                _root: document.body,
                _title: pname + " Specs Edit",
                _blocking: false,
                _scaled: true,
                _headercolor: "var(--theme-color-system)",
                _height: 80,
                _width: 45,
                _licon: null,
                className: 'edit-specs-component'
            };
            flw = makeFLW(fdata);
            flw.grid2 = $$$(flw.body, "div", "fleddat-matrix-1 android");
            flw.grid = $$$(flw.body, "div", "fleddat-matrix");
            flw.grid.pname = pname;
            flw.style.overflowY = "scroll";
            flw.addEventListener("flWindowClosed", function(e) {
                this.remove();
            });

            // labels & fields
            for ([i,lb] of labels.entries()) {
                // labels
                lbel = createLabel(flw.grid, 0, i);
                lbel.innerHTML = lb;
                if (i>=2 && i<=14) lbel.classList.add("fleddat-c1b");
                // fields
                createInput(flw.grid, "number", 1, i).title = "";
                if (i!=0 && i!=1 && i!=26) {
                    //if (i==19) createDisplInput(flw.grid, 2, i);
                    //else createInput(flw.grid, "text", 2, i);
                    const specsInput = createInput(flw.grid, "text", 2, i);
                    if(compsData[lb]) { // 代表在comps表里面存在值
                        let timer = null
                        const specsInputEvent = (e) => {
                            const el = e.target
                            const label = el.getAttribute('list')
                            const data = compsData[label].find(comp => comp[1] === el.value)
                            const costInput = el.previousElementSibling
                            if(data) {
                                costInput.value = data[2]
                            }
                        }
                        specsInput.addEventListener('input', function (e) {
                            if(timer) {
                                clearTimeout(timer)
                                timer = null
                            }
                            timer = setTimeout(() => {
                                specsInputEvent(e)
                            }, 300)
                        })
                        createSelOfInput(specsInput, lb, compsData[lb].map(comp => comp[1]));
                    }
                }
                if (i!=26) {
                    tmp = createInput(flw.grid, "textarea", 3, i);
                    tmp.addEventListener("focusin", function(e) {this.style.height = "calc(var(--fleddat-cellH) * 3 - 0.5em)";});
                    tmp.addEventListener("focusout", function(e) {this.style.height = "";});
                }
            }
            const labelsAfterStartIndex = labels.length
            const textAreaIndex = labelsAfterStartIndex + specsNewLabel.length
            specsNewLabel.forEach((item, i) => {
                const { label, index } = item
                const uiIndex = labelsAfterStartIndex + i
                createLabel(flw.grid, 0, uiIndex).innerHTML = label;
                createInput(flw.grid, "text", 1, uiIndex, 3);
                cellAt(1, uiIndex).value = prj_data[getSheetIndex(index)]
            })


            createInput(flw.grid, "textarea", 0, textAreaIndex, 3, textAreaIndex).style.height = "calc(var(--fleddat-cellH) * 3 - 0.5em)";

            // fill in data
            cellAt(1, 0).value = toNum(prj_data[_nondm]).toFixed(2);
            cellAt(3, 0).value = prj_note[_nondm];
            cellAt(3, 1).value = prj_data[_comments+1];
            for (i=0; i<24; i++) {
                cellAt(1, i+2).value = toNum(prj_data[_nondm+2+2*i]).toFixed(2);
                cellAt(2, i+2).value = prj_data[_nondm+1+2*i];
                cellAt(3, i+2).value = prj_note[_nondm+1+2*i];
            }

            cellAt(0, textAreaIndex).value = prj_data[_comments];


            // calculations
            cellAt(1,1).readOnly = true;
            cellAt(1,26).readOnly = true;
            for (i=0; i<27; i++) cellAt(1,i).onchange = function() {this.value = toNum(this.value).toFixed(2); reCalc(this.parentNode.pname);};
            reCalc(pname);

            // submit button
            var subm = $$$(flw.grid, "div", "fleddat-cell fleddat-submit", pname + "-fleddat-cell-0-6").setAt(0, textAreaIndex + 1, 3, textAreaIndex + 1);
            subm.innerHTML = "Save Data";

            subm.onclick = function(e) {
                const arr = [];
                const cmt = [];
                const appendArr = []
                arr.push($(this.parentNode.pname + "-fleddat-cell-1-0").value);
                cmt.push($(this.parentNode.pname + "-fleddat-cell-3-0").value);
                for (i=2; i<labels.length - 1; i++) {
                    arr.push($(this.parentNode.pname + "-fleddat-cell-2-" + i).value);
                    cmt.push($(this.parentNode.pname + "-fleddat-cell-3-" + i).value);
                    arr.push($(this.parentNode.pname + "-fleddat-cell-1-" + i).value);
                    cmt.push("");
                }
                arr.push($(this.parentNode.pname + "-fleddat-cell-0-" + (labels.length + specsNewLabel.length)).value);
                cmt.push("");
                arr.push($(this.parentNode.pname + "-fleddat-cell-3-1").value);
                cmt.push("");

                specsNewLabel.forEach((item, i) => {
                    const uiIndex = labelsAfterStartIndex + i
                    appendArr.push(cellAt(1, uiIndex).value)
                })

                // send to server
                this.classList.add("spin-cursor");
                google.script.run.withSuccessHandler(ret2 => {
                    this.classList.remove("spin-cursor");
                    if (!ret2) {
                        msgBox("Error", 8, 17, 4, "Project not found.");
                        return;
                    }
                    this.parentNode.parentNode.root.remove();
                    doUpdate();
                }).saveProductSpecs(pname, JSON.stringify(arr), JSON.stringify(cmt), JSON.stringify(appendArr));

            };
        }).getProduct(pname);
    }
</script>

